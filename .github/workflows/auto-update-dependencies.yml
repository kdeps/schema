name: Auto-update Dependencies

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.4'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - uses: gradle/actions/setup-gradle@v4

      - name: Install pkl CLI
        run: |
          PKL_VERSION=$(jq -r '.pkl.version' versions.json)
          curl -L -o pkl "https://github.com/apple/pkl/releases/download/${PKL_VERSION}/pkl-linux-amd64"
          chmod +x pkl
          sudo mv pkl /usr/local/bin/

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch latest PKL release
        id: latest_pkl
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/apple/pkl/releases/latest | jq -r '.tag_name')
          echo "Latest PKL version: $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Get current PKL version
        id: current_pkl
        run: |
          CURRENT_VERSION=$(jq -r '.pkl.version' versions.json)
          echo "Current PKL version: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Compare PKL versions
        id: compare_pkl
        run: |
          LATEST="${{ steps.latest_pkl.outputs.version }}"
          CURRENT="${{ steps.current_pkl.outputs.version }}"

          # Remove 'v' prefix if present
          LATEST_NUM="${LATEST#v}"

          if [ "$LATEST_NUM" != "$CURRENT" ]; then
            echo "New PKL version available: $LATEST_NUM (current: $CURRENT)"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "new_version=$LATEST_NUM" >> $GITHUB_OUTPUT
          else
            echo "Already on latest PKL version: $CURRENT"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Fetch latest pkl-go release
        id: latest_pkl_go
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/apple/pkl-go/releases/latest | jq -r '.tag_name')
          echo "Latest pkl-go version: $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Get current pkl-go version
        id: current_pkl_go
        run: |
          CURRENT_VERSION=$(jq -r '.dependencies."pkl-go".version' versions.json)
          echo "Current pkl-go version: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Compare pkl-go versions
        id: compare_pkl_go
        run: |
          LATEST="${{ steps.latest_pkl_go.outputs.version }}"
          CURRENT="${{ steps.current_pkl_go.outputs.version }}"

          # Remove 'v' prefix if present
          LATEST_NUM="${LATEST#v}"

          if [ "$LATEST_NUM" != "$CURRENT" ]; then
            echo "New pkl-go version available: $LATEST_NUM (current: $CURRENT)"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "new_version=$LATEST_NUM" >> $GITHUB_OUTPUT
          else
            echo "Already on latest pkl-go version: $CURRENT"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if any updates needed
        id: check_updates
        run: |
          PKL_UPDATE="${{ steps.compare_pkl.outputs.needs_update }}"
          PKL_GO_UPDATE="${{ steps.compare_pkl_go.outputs.needs_update }}"

          if [ "$PKL_UPDATE" = "true" ] || [ "$PKL_GO_UPDATE" = "true" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Updates needed:"
            [ "$PKL_UPDATE" = "true" ] && echo "  - PKL: ${{ steps.current_pkl.outputs.version }} → ${{ steps.compare_pkl.outputs.new_version }}"
            [ "$PKL_GO_UPDATE" = "true" ] && echo "  - pkl-go: ${{ steps.current_pkl_go.outputs.version }} → ${{ steps.compare_pkl_go.outputs.new_version }}"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "All dependencies are up to date"
          fi

      - name: Update versions.json
        if: steps.check_updates.outputs.needs_update == 'true'
        run: |
          # Update PKL version if needed
          if [ "${{ steps.compare_pkl.outputs.needs_update }}" = "true" ]; then
            NEW_VERSION="${{ steps.compare_pkl.outputs.new_version }}"
            echo "Updating PKL to $NEW_VERSION in versions.json"
            jq ".pkl.version = \"$NEW_VERSION\"" versions.json > versions.json.tmp && mv versions.json.tmp versions.json
          fi

          # Update pkl-go version if needed
          if [ "${{ steps.compare_pkl_go.outputs.needs_update }}" = "true" ]; then
            NEW_VERSION="${{ steps.compare_pkl_go.outputs.new_version }}"
            echo "Updating pkl-go to $NEW_VERSION in versions.json"
            jq ".dependencies[\"pkl-go\"].version = \"$NEW_VERSION\" | .dependencies[\"pkl-go\"].url = \"package://pkg.pkl-lang.org/pkl-go/pkl.golang@$NEW_VERSION\"" versions.json > versions.json.tmp && mv versions.json.tmp versions.json
          fi

      - name: Update go.mod for pkl-go
        if: steps.compare_pkl_go.outputs.needs_update == 'true'
        run: |
          NEW_VERSION="${{ steps.compare_pkl_go.outputs.new_version }}"
          echo "Updating pkl-go in go.mod to v$NEW_VERSION"
          go get github.com/apple/pkl-go@v$NEW_VERSION
          go mod tidy

      - name: Update PKL version references in files
        if: steps.compare_pkl.outputs.needs_update == 'true'
        run: |
          OLD_VERSION="${{ steps.current_pkl.outputs.version }}"
          NEW_VERSION="${{ steps.compare_pkl.outputs.new_version }}"

          echo "Updating PKL version references"

          # Update build.gradle.kts
          sed -i "s/id(\"org.pkl-lang\") version \"$OLD_VERSION\"/id(\"org.pkl-lang\") version \"$NEW_VERSION\"/g" build.gradle.kts

          # Update minPklVersion in PKL files (excluding external dependencies)
          find deps/pkl -name "*.pkl" -type f ! -path "*/external/*" -exec sed -i "s/@ModuleInfo { minPklVersion = \"$OLD_VERSION\" }/@ModuleInfo { minPklVersion = \"$NEW_VERSION\" }/g" {} \;
          find assets/pkl -name "*.pkl" -type f ! -path "*/external/*" -exec sed -i "s/@ModuleInfo { minPklVersion = \"$OLD_VERSION\" }/@ModuleInfo { minPklVersion = \"$NEW_VERSION\" }/g" {} \;

      - name: Download and update dependencies
        if: steps.check_updates.outputs.needs_update == 'true'
        run: |
          echo "Running dependency download and update scripts"
          chmod +x scripts/*.sh

          # Ensure deps/pkl directory exists
          mkdir -p deps/pkl

          # Download dependencies
          ./scripts/download_deps.sh

          # Fix imports
          ./scripts/fix_deps_imports.sh

      - name: Update embedded assets
        if: steps.check_updates.outputs.needs_update == 'true'
        run: |
          echo "Updating embedded assets"
          mkdir -p assets/pkl

          # Copy PKL files from deps/pkl to assets/pkl
          if ls deps/pkl/*.pkl 1> /dev/null 2>&1; then
            cp deps/pkl/*.pkl assets/pkl/
            echo "✓ Copied PKL files from deps/pkl to assets/pkl"
          else
            echo "⚠ No PKL files found in deps/pkl/"
          fi

          # Note: external dependencies are already in assets/pkl/external/
          # created by download_deps.sh script
          if [ -d "assets/pkl/external" ]; then
            echo "✓ External dependencies exist at assets/pkl/external"
          else
            echo "⚠ No external dependencies found (download_deps.sh may have failed)"
          fi

      - name: Run tests
        if: steps.check_updates.outputs.needs_update == 'true'
        run: |
          echo "Running Go tests"
          cd assets && go test -v ./...

      - name: Generate PR body
        if: steps.check_updates.outputs.needs_update == 'true'
        id: pr_body
        run: |
          PKL_UPDATE="${{ steps.compare_pkl.outputs.needs_update }}"
          PKL_GO_UPDATE="${{ steps.compare_pkl_go.outputs.needs_update }}"

          # Start PR body
          cat > pr_body.md << 'EOF'
          ## Auto-update Dependencies

          This PR automatically updates PKL and pkl-go dependencies to their latest versions.

          EOF

          # Add PKL section if updated
          if [ "$PKL_UPDATE" = "true" ]; then
            cat >> pr_body.md << EOF
          ### PKL Update

          **Version:** \`${{ steps.current_pkl.outputs.version }}\` → \`${{ steps.compare_pkl.outputs.new_version }}\`

          **Changes:**
          - Updated \`versions.json\`
          - Updated \`build.gradle.kts\`
          - Updated \`minPklVersion\` in all .pkl files (deps/pkl and assets/pkl)
          - Downloaded updated PKL dependencies
          - Updated import paths
          - Updated embedded assets

          **Release Notes:** https://github.com/apple/pkl/releases/tag/v${{ steps.compare_pkl.outputs.new_version }}

          EOF
          fi

          # Add pkl-go section if updated
          if [ "$PKL_GO_UPDATE" = "true" ]; then
            cat >> pr_body.md << EOF
          ### pkl-go Update

          **Version:** \`${{ steps.current_pkl_go.outputs.version }}\` → \`${{ steps.compare_pkl_go.outputs.new_version }}\`

          **Changes:**
          - Updated \`versions.json\`
          - Updated \`go.mod\` and \`go.sum\`
          - Downloaded updated pkl-go dependencies
          - Updated import paths
          - Updated embedded assets

          **Release Notes:** https://github.com/apple/pkl-go/releases/tag/v${{ steps.compare_pkl_go.outputs.new_version }}

          EOF
          fi

          # Add test results footer
          cat >> pr_body.md << 'EOF'

          ### Test Results

          All Go tests passed successfully after the update.

          EOF

          # Add footer
          cat >> pr_body.md << 'EOF'

          ---
          *This PR was automatically created by the auto-update-dependencies workflow.*
          EOF

          # Output for use in next step
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat pr_body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate commit message and branch name
        if: steps.check_updates.outputs.needs_update == 'true'
        id: commit_info
        run: |
          PKL_UPDATE="${{ steps.compare_pkl.outputs.needs_update }}"
          PKL_GO_UPDATE="${{ steps.compare_pkl_go.outputs.needs_update }}"

          # Build component lists
          COMPONENTS_LOWER=()
          COMPONENTS_UPPER=()
          BRANCH_PARTS=()

          if [ "$PKL_UPDATE" = "true" ]; then
            COMPONENTS_LOWER+=("pkl to ${{ steps.compare_pkl.outputs.new_version }}")
            COMPONENTS_UPPER+=("PKL to ${{ steps.compare_pkl.outputs.new_version }}")
            BRANCH_PARTS+=("pkl-${{ steps.compare_pkl.outputs.new_version }}")
          fi

          if [ "$PKL_GO_UPDATE" = "true" ]; then
            COMPONENTS_LOWER+=("pkl-go to ${{ steps.compare_pkl_go.outputs.new_version }}")
            COMPONENTS_UPPER+=("pkl-go to ${{ steps.compare_pkl_go.outputs.new_version }}")
            BRANCH_PARTS+=("pkl-go-${{ steps.compare_pkl_go.outputs.new_version }}")
          fi

          # Join components with "and"
          if [ ${#COMPONENTS_LOWER[@]} -eq 1 ]; then
            LOWER_MSG="${COMPONENTS_LOWER[0]}"
            UPPER_MSG="${COMPONENTS_UPPER[0]}"
          else
            LOWER_MSG="${COMPONENTS_LOWER[0]} and ${COMPONENTS_LOWER[1]}"
            UPPER_MSG="${COMPONENTS_UPPER[0]} and ${COMPONENTS_UPPER[1]}"
          fi

          COMMIT_MSG="chore: auto-update $LOWER_MSG"
          BRANCH_NAME="auto-update-$(IFS='-'; echo "${BRANCH_PARTS[*]}")"
          PR_TITLE="chore: auto-update $UPPER_MSG"

          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_updates.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: ${{ steps.commit_info.outputs.commit_message }}
          title: ${{ steps.commit_info.outputs.pr_title }}
          body: ${{ steps.pr_body.outputs.body }}
          branch: ${{ steps.commit_info.outputs.branch_name }}
          delete-branch: true
          labels: dependencies,autoupdate
