/// Core PKL modules for KDEPS
///
/// This package contains essential modules used by the Kdeps framework,
/// providing fundamental functionalities and utilities to build upon.
///
/// Authors:
/// - Joel Bryan Juliano <joelbryan.juliano@gmail.com>
amends "pkl:Project"

// Reads the VERSION environment variables
local version_num = read?("env:VERSION")

package {
    // The name of the package.
    name = "core"

    // The authors of the package.
    authors {
        "Joel Bryan Juliano <joelbryan.juliano@gmail.com>"
    }

    // The version of the package, derived from the environment variable `VERSION`.
    // If the variable is not set, defaults to "0.0.1-SNAPSHOT".
    // Handles multiple version formats and converts them to valid semver.
    version = if (version_num != null)
        // Remove any prefix like "v" or "core@v"
        let (cleaned = version_num.replaceFirst("\(name)@v", "").replaceFirst(Regex("^v"), ""))
        // Handle 4-part versions by converting to 3-part (e.g., 0.0.0.0 -> 0.0.0)
        if (cleaned.matches(Regex("^\\d+\\.\\d+\\.\\d+\\.\\d+$")))
            cleaned.replaceFirst(Regex("^(\\d+\\.\\d+\\.\\d+)\\.\\d+$"), "$1")
        // Handle standard semver formats (3-part with optional pre-release/build metadata)
        else if (cleaned.matches(Regex("^\\d+\\.\\d+\\.\\d+(-[\\w\\.-]+)?(\\+[\\w\\.-]+)?$")))
            cleaned
        // For any other format, use as-is and let validation catch issues
        else cleaned
    else "0.0.1-SNAPSHOT"

    // The base URI for the package, used for package resolution and access.
    baseUri = "package://schema.kdeps.com/core"

    // The URL for the zipped package release.
    packageZipUrl = if (version_num != null) "https://github.com/kdeps/schema/releases/download/\(version_num)/\(name)@\(version).zip" else "https://github.com/kdeps/schema/releases/download/v0.0.1-SNAPSHOT/\(name)@\(version).zip"

    // The URL for the source code repository.
    sourceCode = "https://github.com/kdeps/schema"

    // The URL scheme for linking to specific lines in the source code.
    sourceCodeUrlScheme = if (version_num != null) "\(sourceCode)/blob/\(version_num)%{path}#L%{line}-L%{endLine}" else "\(sourceCode)/blob/main%{path}#L%{line}-L%{endLine}"

    // The documentation URL for the package.
    documentation = "https://schema.kdeps.com"

    // The license under which the package is distributed.
    license = "Apache-2.0"

    // A brief description of the package's purpose.
    description = "Core PKL modules for KDEPS"
}

dependencies {
    ["uri"] { uri = "package://pkg.pkl-lang.org/pkl-pantry/pkl.experimental.uri@1.0.3" }
}
