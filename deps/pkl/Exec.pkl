@go.Package { name = "github.com/kdeps/schema/gen/exec" }

open module org.kdeps.pkl.Exec

import "package://pkg.pkl-lang.org/pkl-go/pkl.golang@0.5.0#/go.pkl"

resources: Mapping<String, ResourceExec>?

class ResourceExec {
  hidden envStringRegex = Regex(#"^[a-zA-Z_]\w*$"#)
  hidden isValidEnv = (str) ->
  if (str.matches(envStringRegex))
    true
  else
    throw("Error: Invalid env name: The env name contains invalid characters. Please ensure it only includes alphanumeric characters (letters and numbers), does not start with a number, and is not empty.")
  env: Mapping<String(isValidEnv), String>?
  command: String
  stderr: String?
  stdout: String?
  exitCode: Int? = 0
  timestamp: UInt32?
  timeoutSeconds: Int? = 60
}

function resource(id: String): ResourceExec =
  if (!resources.isEmpty)
    if (resources.containsKey(id))
      resources[id]
    else
      new ResourceExec {
        command = ""
        stderr = ""
        stdout = ""
        exitCode = 0
      }
  else
    new ResourceExec {
      command = ""
      stderr = ""
      stdout = ""
      exitCode = 0
    }

function stderr(id: String): String =
  if (resource(id).stderr != null)
    resource(id).stderr
  else
    ""

function stdout(id: String): String =
  if (resource(id).stdout != null)
    resource(id).stdout
  else
    ""

function exitCode(id: String): Int =
  if (resource(id).exitCode != null)
    resource(id).exitCode
  else
    0

function env(id: String, envName: String): String =
  if (resource(id).env != null)
    if (!resource(id).env.isEmpty)
      if (resource(id).env.containsKey(envName)) resource(id).env[envName] else ""
    else
      ""
  else
    ""
