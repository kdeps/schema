/// Abstractions for managing records in a for loop
///
/// This module provides functions to interact with records representing iterations or elements in a for loop.
/// The module supports retrieving, navigating, and listing records without requiring a specific identifier.
@ModuleInfo { minPklVersion = "0.28.1" }

@go.Package { name = "github.com/kdeps/schema/gen/item" }

open module org.kdeps.pkl.Item

import "package://pkg.pkl-lang.org/pkl-go/pkl.golang@0.9.0#/go.pkl"
import "package://pkg.pkl-lang.org/pkl-pantry/pkl.experimental.uri@1.0.3#/URI.pkl"
import "pkl:test"
import "pkl:json"

/// Retrieves the record for the current iteration
///
/// Returns the textual content of the most recent loop record, or an empty string if no record is found.
function current(): String = read("item:/?op=current")?.text ?? ""

/// Retrieves the record for the previous iteration
///
/// Returns the textual content of the previous loop record, or an empty string if no previous record exists.
function prev(): String = read("item:/?op=prev")?.text ?? ""

/// Retrieves the record for the next iteration
///
/// Returns the textual content of the next loop record, or an empty string if no next record exists.
function next(): String = read("item:/?op=next")?.text ?? ""

/// Lists all records associated with the for loop
///
/// Returns a textual representation of all loop records, or an empty string if no records are found.
function list(): String = read("item:/?op=list")?.text ?? ""

/// Lists all record results associated with the for loop
///
/// Returns a textual representation of all loop records, or an empty string if no records are found.
function results(): Listing =
  if (test.catchOrNull(() -> (new json.Parser { useMapping = true }).parse(read("item:/?op=values")?.text)) == null)
    (new json.Parser { useMapping = false }).parse(read("item:/?op=values")?.text)
  else
    null

/// Sets or updates an item record with a new [value]
///
/// Returns the set value as confirmation.
///
/// [value]: The value to store.
function set(value: String): String = read("item:/?op=set&value=\(URI.encodeComponent(value))")?.text ?? ""
